"use strict";(self.webpackChunkvulkan_doc=self.webpackChunkvulkan_doc||[]).push([[9114],{3345:(e,s,n)=>{n.r(s),n.d(s,{assets:()=>i,contentTitle:()=>d,default:()=>u,frontMatter:()=>a,metadata:()=>c,toc:()=>l});var t=n(4848),r=n(8453);const a={title:"\u591asubpass\u6e32\u67d3",categories:["Vulkan\u6280\u672f"],tags:["\u56fe\u5f62\u57fa\u7840"],date:new Date("2025-07-02T10:22:30.000Z"),authors:"sumcai"},d="\u591asubpass\u6e32\u67d3",c={permalink:"/blog/18.multi subpass",source:"@site/blog/18.multi subpass.md",title:"\u591asubpass\u6e32\u67d3",description:"\u591a Subpass \u7684 Vulkan \u6e32\u67d3\u6d41\u7a0b\uff0c\u975e\u5e38\u9002\u5408\u7528\u4e8e G-buffer + \u5149\u7167\u3001\u5148\u753b\u518d\u540e\u5904\u7406\u7b49\u573a\u666f\u3002",date:"2025-07-02T10:22:30.000Z",tags:[{inline:!0,label:"\u56fe\u5f62\u57fa\u7840",permalink:"/blog/tags/\u56fe\u5f62\u57fa\u7840"}],readingTime:3.425,hasTruncateMarker:!1,authors:[{name:"\u82cf\u660e\u624d",title:"Vulkan\u9a71\u52a8\u586b\u5751\u72ee",url:"https://github.com/sumcai",email:"sumcai@163.com",page:{permalink:"/blog/authors/sumcai"},description:"\u6709\u4efb\u4f55\u95ee\u9898\uff0c\u8bf7\u8054\u7cfb sumcai@163.com",socials:{github:"https://github.com/sumcai"},imageURL:"https://avatars.githubusercontent.com/u/76768485?v=4",key:"sumcai"}],frontMatter:{title:"\u591asubpass\u6e32\u67d3",categories:["Vulkan\u6280\u672f"],tags:["\u56fe\u5f62\u57fa\u7840"],date:"2025-07-02T10:22:30.000Z",authors:"sumcai"},unlisted:!1,prevItem:{title:"VkPhysicalDeviceFeatures \u5168\u5b57\u6bb5\u8be6\u89e3",permalink:"/blog/19.physical device features"},nextItem:{title:"vulkan\u4e2d\u7684MSAA resolvemode",permalink:"/blog/17.vulkan_msaa_resolvemode"}},i={authorsImageUrls:[void 0]},l=[{value:"\ud83c\udfaf \u793a\u4f8b\u76ee\u6807",id:"-\u793a\u4f8b\u76ee\u6807",level:2},{value:"\u2705 \u6d89\u53ca\u7684 Attachment\uff08\u603b\u5171 2 \u4e2a\uff09",id:"-\u6d89\u53ca\u7684-attachment\u603b\u5171-2-\u4e2a",level:2},{value:"\ud83e\udde9 \u6b65\u9aa4\u603b\u89c8",id:"-\u6b65\u9aa4\u603b\u89c8",level:2},{value:"\ud83d\udcdc \u4ee3\u7801\u793a\u4f8b",id:"-\u4ee3\u7801\u793a\u4f8b",level:2},{value:"1. \u5b9a\u4e49 Attachments",id:"1-\u5b9a\u4e49-attachments",level:3},{value:"2. \u5b9a\u4e49 Subpasses",id:"2-\u5b9a\u4e49-subpasses",level:3},{value:"Subpass 0\uff1a\u5199\u5165 Attachment 0",id:"subpass-0\u5199\u5165-attachment-0",level:4},{value:"Subpass 1\uff1a\u8bfb\u53d6 Attachment 0 \u4f5c\u4e3a\u8f93\u5165\uff0c\u5199\u5165 Attachment 1",id:"subpass-1\u8bfb\u53d6-attachment-0-\u4f5c\u4e3a\u8f93\u5165\u5199\u5165-attachment-1",level:4},{value:"3. \u6dfb\u52a0 Subpass \u4f9d\u8d56\uff08\u540c\u6b65\u4e24\u4e2a Subpass\uff09",id:"3-\u6dfb\u52a0-subpass-\u4f9d\u8d56\u540c\u6b65\u4e24\u4e2a-subpass",level:3},{value:"4. \u521b\u5efa Render Pass",id:"4-\u521b\u5efa-render-pass",level:3},{value:"5. \u5728 Command Buffer \u4e2d\u4f7f\u7528",id:"5-\u5728-command-buffer-\u4e2d\u4f7f\u7528",level:3},{value:"\ud83d\udce6 \u9644\u52a0\u8bf4\u660e",id:"-\u9644\u52a0\u8bf4\u660e",level:2},{value:"\ud83e\udde0 Shader \u4e2d\u5982\u4f55\u8bfb\u53d6\u4e0a\u4e00\u4e2a Subpass \u7684\u7ed3\u679c\uff1f",id:"-shader-\u4e2d\u5982\u4f55\u8bfb\u53d6\u4e0a\u4e00\u4e2a-subpass-\u7684\u7ed3\u679c",level:2},{value:"\u2705 \u603b\u7ed3",id:"-\u603b\u7ed3",level:2}];function h(e){const s={code:"code",h2:"h2",h3:"h3",h4:"h4",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(s.p,{children:"\u591a Subpass \u7684 Vulkan \u6e32\u67d3\u6d41\u7a0b\uff0c\u975e\u5e38\u9002\u5408\u7528\u4e8e G-buffer + \u5149\u7167\u3001\u5148\u753b\u518d\u540e\u5904\u7406\u7b49\u573a\u666f\u3002"}),"\n",(0,t.jsx)(s.hr,{}),"\n",(0,t.jsx)(s.h2,{id:"-\u793a\u4f8b\u76ee\u6807",children:"\ud83c\udfaf \u793a\u4f8b\u76ee\u6807"}),"\n",(0,t.jsxs)(s.p,{children:["\u6211\u4eec\u6784\u5efa\u4e00\u4e2a\u7b80\u5355\u7684 ",(0,t.jsx)(s.strong,{children:"\u53cc Subpass Render Pass"}),"\uff1a"]}),"\n",(0,t.jsxs)(s.ol,{children:["\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.strong,{children:"Subpass 0"}),"\uff1a\u7ed8\u5236\u573a\u666f\uff0c\u8f93\u51fa\u5230\u989c\u8272\u9644\u4ef6\uff08Color Attachment 0\uff09"]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.strong,{children:"Subpass 1"}),"\uff1a\u5bf9\u524d\u9762\u7684\u8f93\u51fa\u505a\u4e00\u4e2a\u540e\u5904\u7406\uff0c\u8bfb\u53d6 Subpass 0 \u7684\u989c\u8272\u4f5c\u4e3a\u8f93\u5165 attachment\uff0c\u518d\u8f93\u51fa\u5230\u5c4f\u5e55\uff08Color Attachment 1\uff09"]}),"\n"]}),"\n",(0,t.jsx)(s.hr,{}),"\n",(0,t.jsx)(s.h2,{id:"-\u6d89\u53ca\u7684-attachment\u603b\u5171-2-\u4e2a",children:"\u2705 \u6d89\u53ca\u7684 Attachment\uff08\u603b\u5171 2 \u4e2a\uff09"}),"\n",(0,t.jsxs)(s.table,{children:[(0,t.jsx)(s.thead,{children:(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.th,{children:"Attachment Index"}),(0,t.jsx)(s.th,{children:"\u7c7b\u578b"}),(0,t.jsx)(s.th,{children:"\u7528\u9014"})]})}),(0,t.jsxs)(s.tbody,{children:[(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:"0"}),(0,t.jsx)(s.td,{children:"Color Attachment"}),(0,t.jsx)(s.td,{children:"\u7528\u4e8e Subpass 0 \u8f93\u51fa"})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:"1"}),(0,t.jsx)(s.td,{children:"Color Attachment"}),(0,t.jsx)(s.td,{children:"\u7528\u4e8e Subpass 1 \u8f93\u51fa\u6700\u7ec8\u753b\u9762"})]})]})]}),"\n",(0,t.jsx)(s.hr,{}),"\n",(0,t.jsx)(s.h2,{id:"-\u6b65\u9aa4\u603b\u89c8",children:"\ud83e\udde9 \u6b65\u9aa4\u603b\u89c8"}),"\n",(0,t.jsxs)(s.ol,{children:["\n",(0,t.jsx)(s.li,{children:"\u5b9a\u4e49\u4e24\u4e2a\u9644\u4ef6\uff08Attachment 0 \u548c 1\uff09"}),"\n",(0,t.jsxs)(s.li,{children:["\u521b\u5efa\u4e24\u4e2a Subpass\uff1a","\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsx)(s.li,{children:"Subpass 0\uff1a\u5199\u5165 Attachment 0"}),"\n",(0,t.jsx)(s.li,{children:"Subpass 1\uff1a\u8bfb\u53d6 Attachment 0\uff0c\u5199\u5165 Attachment 1"}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(s.li,{children:"\u8bbe\u7f6e Subpass Dependency \u540c\u6b65\u4e24\u4e2a\u9636\u6bb5"}),"\n",(0,t.jsxs)(s.li,{children:["\u7528 ",(0,t.jsx)(s.code,{children:"vkCmdNextSubpass()"})," \u8fc7\u6e21\u5230\u4e0b\u4e00\u4e2a subpass"]}),"\n"]}),"\n",(0,t.jsx)(s.hr,{}),"\n",(0,t.jsx)(s.h2,{id:"-\u4ee3\u7801\u793a\u4f8b",children:"\ud83d\udcdc \u4ee3\u7801\u793a\u4f8b"}),"\n",(0,t.jsx)(s.p,{children:"\u4e0b\u9762\u662f\u6838\u5fc3\u7ed3\u6784\u4ee3\u7801\uff08C++ \u4f2a\u4ee3\u7801 + Vulkan\uff09\uff1a"}),"\n",(0,t.jsx)(s.h3,{id:"1-\u5b9a\u4e49-attachments",children:"1. \u5b9a\u4e49 Attachments"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{children:"cpp\u590d\u5236\u7f16\u8f91VkAttachmentDescription attachments[2] = {};\r\n\r\n// Attachment 0: Intermediate color output\r\nattachments[0].format = VK_FORMAT_R8G8B8A8_UNORM;\r\nattachments[0].samples = VK_SAMPLE_COUNT_1_BIT;\r\nattachments[0].loadOp = VK_ATTACHMENT_LOAD_OP_CLEAR;\r\nattachments[0].storeOp = VK_ATTACHMENT_STORE_OP_STORE;\r\nattachments[0].initialLayout = VK_IMAGE_LAYOUT_UNDEFINED;\r\nattachments[0].finalLayout = VK_IMAGE_LAYOUT_SHADER_READ_ONLY_OPTIMAL;\r\n\r\n// Attachment 1: Final output (present)\r\nattachments[1].format = swapchainImageFormat;\r\nattachments[1].samples = VK_SAMPLE_COUNT_1_BIT;\r\nattachments[1].loadOp = VK_ATTACHMENT_LOAD_OP_CLEAR;\r\nattachments[1].storeOp = VK_ATTACHMENT_STORE_OP_STORE;\r\nattachments[1].initialLayout = VK_IMAGE_LAYOUT_UNDEFINED;\r\nattachments[1].finalLayout = VK_IMAGE_LAYOUT_PRESENT_SRC_KHR;\n"})}),"\n",(0,t.jsx)(s.hr,{}),"\n",(0,t.jsx)(s.h3,{id:"2-\u5b9a\u4e49-subpasses",children:"2. \u5b9a\u4e49 Subpasses"}),"\n",(0,t.jsx)(s.h4,{id:"subpass-0\u5199\u5165-attachment-0",children:"Subpass 0\uff1a\u5199\u5165 Attachment 0"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{children:"cpp\u590d\u5236\u7f16\u8f91VkAttachmentReference colorRef0 = { 0, VK_IMAGE_LAYOUT_COLOR_ATTACHMENT_OPTIMAL };\r\n\r\nVkSubpassDescription subpass0 = {};\r\nsubpass0.pipelineBindPoint = VK_PIPELINE_BIND_POINT_GRAPHICS;\r\nsubpass0.colorAttachmentCount = 1;\r\nsubpass0.pColorAttachments = &colorRef0;\n"})}),"\n",(0,t.jsx)(s.h4,{id:"subpass-1\u8bfb\u53d6-attachment-0-\u4f5c\u4e3a\u8f93\u5165\u5199\u5165-attachment-1",children:"Subpass 1\uff1a\u8bfb\u53d6 Attachment 0 \u4f5c\u4e3a\u8f93\u5165\uff0c\u5199\u5165 Attachment 1"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{children:"cpp\u590d\u5236\u7f16\u8f91VkAttachmentReference inputRef = { 0, VK_IMAGE_LAYOUT_SHADER_READ_ONLY_OPTIMAL };\r\nVkAttachmentReference colorRef1 = { 1, VK_IMAGE_LAYOUT_COLOR_ATTACHMENT_OPTIMAL };\r\n\r\nVkSubpassDescription subpass1 = {};\r\nsubpass1.pipelineBindPoint = VK_PIPELINE_BIND_POINT_GRAPHICS;\r\nsubpass1.inputAttachmentCount = 1;\r\nsubpass1.pInputAttachments = &inputRef;\r\nsubpass1.colorAttachmentCount = 1;\r\nsubpass1.pColorAttachments = &colorRef1;\n"})}),"\n",(0,t.jsx)(s.hr,{}),"\n",(0,t.jsx)(s.h3,{id:"3-\u6dfb\u52a0-subpass-\u4f9d\u8d56\u540c\u6b65\u4e24\u4e2a-subpass",children:"3. \u6dfb\u52a0 Subpass \u4f9d\u8d56\uff08\u540c\u6b65\u4e24\u4e2a Subpass\uff09"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{children:"cpp\u590d\u5236\u7f16\u8f91VkSubpassDependency dependency = {};\r\ndependency.srcSubpass = 0;\r\ndependency.dstSubpass = 1;\r\ndependency.srcStageMask = VK_PIPELINE_STAGE_COLOR_ATTACHMENT_OUTPUT_BIT;\r\ndependency.dstStageMask = VK_PIPELINE_STAGE_FRAGMENT_SHADER_BIT;\r\ndependency.srcAccessMask = VK_ACCESS_COLOR_ATTACHMENT_WRITE_BIT;\r\ndependency.dstAccessMask = VK_ACCESS_INPUT_ATTACHMENT_READ_BIT;\n"})}),"\n",(0,t.jsx)(s.hr,{}),"\n",(0,t.jsx)(s.h3,{id:"4-\u521b\u5efa-render-pass",children:"4. \u521b\u5efa Render Pass"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{children:"cpp\u590d\u5236\u7f16\u8f91VkSubpassDescription subpasses[] = { subpass0, subpass1 };\r\n\r\nVkRenderPassCreateInfo renderPassInfo{};\r\nrenderPassInfo.sType = VK_STRUCTURE_TYPE_RENDER_PASS_CREATE_INFO;\r\nrenderPassInfo.attachmentCount = 2;\r\nrenderPassInfo.pAttachments = attachments;\r\nrenderPassInfo.subpassCount = 2;\r\nrenderPassInfo.pSubpasses = subpasses;\r\nrenderPassInfo.dependencyCount = 1;\r\nrenderPassInfo.pDependencies = &dependency;\r\n\r\nVkRenderPass renderPass;\r\nvkCreateRenderPass(device, &renderPassInfo, nullptr, &renderPass);\n"})}),"\n",(0,t.jsx)(s.hr,{}),"\n",(0,t.jsx)(s.h3,{id:"5-\u5728-command-buffer-\u4e2d\u4f7f\u7528",children:"5. \u5728 Command Buffer \u4e2d\u4f7f\u7528"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{children:"cpp\u590d\u5236\u7f16\u8f91vkCmdBeginRenderPass(cmdBuffer, &renderPassBeginInfo, VK_SUBPASS_CONTENTS_INLINE);\r\n\r\n// --- Subpass 0 ---\r\nvkCmdBindPipeline(cmdBuffer, ..., pipeline0);\r\nvkCmdDraw(cmdBuffer, ...);\r\n\r\n// \u5207\u6362\u5230 Subpass 1\r\nvkCmdNextSubpass(cmdBuffer, VK_SUBPASS_CONTENTS_INLINE);\r\n\r\n// --- Subpass 1 ---\r\nvkCmdBindPipeline(cmdBuffer, ..., pipeline1);\r\nvkCmdDraw(cmdBuffer, ...);\r\n\r\nvkCmdEndRenderPass(cmdBuffer);\n"})}),"\n",(0,t.jsx)(s.hr,{}),"\n",(0,t.jsx)(s.h2,{id:"-\u9644\u52a0\u8bf4\u660e",children:"\ud83d\udce6 \u9644\u52a0\u8bf4\u660e"}),"\n",(0,t.jsxs)(s.table,{children:[(0,t.jsx)(s.thead,{children:(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.th,{children:"\u540d\u79f0"}),(0,t.jsx)(s.th,{children:"\u8bf4\u660e"})]})}),(0,t.jsxs)(s.tbody,{children:[(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"vkCmdNextSubpass()"})}),(0,t.jsx)(s.td,{children:"\u660e\u786e\u5207\u6362\u5230\u4e0b\u4e00\u4e2a Subpass"})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"input attachment"})}),(0,t.jsx)(s.td,{children:"\u53ea\u5141\u8bb8\u5f53\u524d framebuffer \u7684 image \u4f5c\u53ea\u8bfb\u4f7f\u7528"})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:"Pipeline layout"}),(0,t.jsxs)(s.td,{children:["Subpass 1 \u7684 fragment shader \u4e2d\u7528 ",(0,t.jsx)(s.code,{children:"inputAttachment"})," \u8bfb\u53d6 Subpass 0 \u7684\u7ed3\u679c"]})]})]})]}),"\n",(0,t.jsx)(s.hr,{}),"\n",(0,t.jsx)(s.h2,{id:"-shader-\u4e2d\u5982\u4f55\u8bfb\u53d6\u4e0a\u4e00\u4e2a-subpass-\u7684\u7ed3\u679c",children:"\ud83e\udde0 Shader \u4e2d\u5982\u4f55\u8bfb\u53d6\u4e0a\u4e00\u4e2a Subpass \u7684\u7ed3\u679c\uff1f"}),"\n",(0,t.jsx)(s.p,{children:"\u5728 Subpass 1 \u7684 Fragment Shader\uff1a"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{children:"glsl\u590d\u5236\u7f16\u8f91layout (input_attachment_index = 0, set = 0, binding = 0) uniform subpassInput inputColor;\r\n\r\nvoid main() {\r\n    vec4 color = subpassLoad(inputColor);\r\n    // \u505a\u4e00\u4e9b\u540e\u5904\u7406\u64cd\u4f5c\r\n}\n"})}),"\n",(0,t.jsx)(s.hr,{}),"\n",(0,t.jsx)(s.h2,{id:"-\u603b\u7ed3",children:"\u2705 \u603b\u7ed3"}),"\n",(0,t.jsxs)(s.table,{children:[(0,t.jsx)(s.thead,{children:(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.th,{children:"\u6b65\u9aa4"}),(0,t.jsx)(s.th,{children:"\u52a8\u4f5c"})]})}),(0,t.jsxs)(s.tbody,{children:[(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:"\u5b9a\u4e49\u591a\u4e2a attachment"}),(0,t.jsx)(s.td,{children:"\u63cf\u8ff0 color / depth \u8f93\u51fa"})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:"\u521b\u5efa\u591a\u4e2a subpass"}),(0,t.jsx)(s.td,{children:"\u6307\u5b9a\u8c01\u5199\u3001\u8c01\u8bfb"})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:"\u8bbe\u7f6e dependency"}),(0,t.jsx)(s.td,{children:"\u660e\u786e\u8bfb\u5199\u5148\u540e\u987a\u5e8f"})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"vkCmdNextSubpass"})}),(0,t.jsx)(s.td,{children:"\u5207\u6362\u9636\u6bb5"})]})]})]})]})}function u(e={}){const{wrapper:s}={...(0,r.R)(),...e.components};return s?(0,t.jsx)(s,{...e,children:(0,t.jsx)(h,{...e})}):h(e)}},8453:(e,s,n)=>{n.d(s,{R:()=>d,x:()=>c});var t=n(6540);const r={},a=t.createContext(r);function d(e){const s=t.useContext(a);return t.useMemo((function(){return"function"==typeof e?e(s):{...s,...e}}),[s,e])}function c(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:d(e.components),t.createElement(a.Provider,{value:s},e.children)}}}]);